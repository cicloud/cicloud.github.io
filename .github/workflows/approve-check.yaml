name: Mergeable Check

on:
  pull_request:
    types: [ opened, synchronize, labeled, unlabeled ]

permissions:
  pull-requests: read
  contents: read

jobs:
  label-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}

      - name: Check PR Labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Checking PR #${PR_NUMBER}"
          
          exit 1
          
          # 获取所有标签并打印
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')
          echo "Current labels:"
          echo "$LABELS"

          # 检查必需标签
          REQUIRED_LABELS=("ready" "lgtm" "approved")
          MISSING_LABELS=()

          for LABEL in "${REQUIRED_LABELS[@]}"; do
            if ! echo "$LABELS" | grep -q "$LABEL"; then
              MISSING_LABELS+=("$LABEL")
            fi
          done

          # 检查是否有缺失的标签
          if [ ${#MISSING_LABELS[@]} -gt 0 ]; then
            echo "::error::Missing required labels: ${MISSING_LABELS[*]}"
            exit 1
          fi

          # 检查 hold 标签
          if echo "$LABELS" | grep -q "hold"; then
            echo "::error::Label 'hold' is present, cannot merge"
            exit 1
          fi

          echo "All required labels are present and no blocking labels found"

  publish-failure-announcement:
    runs-on: ubuntu-latest
    needs: [ label-check ]
    if: always() && contains(needs.*.result, 'failure')
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Publish Failure Announcement -> Feishu
        run: |
          VERSION=${{ github.sha }} \
          MESSAGE=$(echo '${{ github.event.pull_request.title }}' | sed -E ':a;N;$!ba;s/\r{0,1}\n/\\n/g') \
          GITHUB_RUN_ID=${{ github.run_id }} \
          FAILED_JOBS="${{ toJson(needs) }}" \
            ./publish-failure-announcement.sh |
          curl -X POST -H "Content-Type: application/json" \
            --data-binary @- \
            "https://open.feishu.cn/open-apis/bot/v2/hook/3af42f8f-ba8b-4051-8964-ecfce869d2d9"
